<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="dao.js"></script>
    <title>Terminal</title>
    <link rel="stylesheet" href="App.css">
</head>
<body>
    <div class="container">
        <div>
            <div class="root">
                ~custodianOS $
            </div>
            <div class="message"></div>
            <br style="clear: both"/>
            <br style="clear: both"/>
            <div class="text"></div>
        </div>
    </div>
    <script>

        const electron = require('electron');
        const {ipcRenderer, app} = electron;
        //const ul = document.querySelector('ul');
        const message = document.querySelector(".message");
        const text = document.querySelector(".text");

        let typing = false;
        let continueMessage = false;
        let typeMessageSpeed = 10; // The speed of the messages from the system being typed
        let stage = 0;




        text.innerHTML = ""; // Prevents garbage data from initialization

        typeMessage("Welcome to CustodianOS, please type your provided identification number.");

        window.onkeydown = key => this.handleKeyPress(key);

        handleKeyPress = (event) =>{
            if(typing){
                return;
            }

            if (event.key === 'Enter'){
                console.log("Enter pressed!");
                handleCommand();
            }else if (event.keyCode === 8){
                console.log("Backspace pressed!");
                text.innerHTML = text.innerHTML.substr(0, text.innerHTML.length-1);
            }else if(event.keyCode < 48 && event.keyCode !== 32){
                event.preventDefault();
            }
            else {
                text.innerHTML += event.key;
            }
        };

        // Catch test clear
        ipcRenderer.on('text:clear', ()=>{
            text.innerHTML = "";
        });

        function fetchQuestion() {
            query("SELECT * FROM Question where Stage = ?", [stage]).then(res =>{

                typeMessage(res.Question);
            });
            return;
        }

        async function handleCommand() {
            console.log("Handling command!");
            let command = text.innerHTML.replace(/\s/g, " ").toLowerCase();
            text.innerHTML = "";

            if (continueMessage){
                switch (command) {
                    case "y":
                        fetchQuestion();
                        continueMessage = false;
                        return;
                    case "n":
                        typeMessage("Your loss");
                        setTimeout(function(){ typeMessage("If you change your mind: press Y") }, 3000);
                        return;
                    default:
                        return;
                }
            }

            if (command === "tell me a joke"){
                message.innerHTML = "";
                typeMessage("Don’t use “beef stew” as a computer password. It’s not stroganoff.");
                return;
            }else{
                switch (stage) {
                    case 0:
                        query("SELECT * FROM User where ID = ?", [command]).then(res =>{

                            if (res == undefined){
                                typeMessage("Identification number not recognized, please try again.")
                            }else{
                                console.log("name: " + res.Name);
                                stage = res.Stage;

                                if (stage === 0){

                                }else {
                                    typeMessage("Welcome back " + res.Name + " would you like to continue on your quest? [Y/N]");
                                    continueMessage = true;

                                }
                            }
                        });
                        break;
                }
            }
        }

        function typeMessage(str){
            if (typing){
                return;
            }
            typing = true;
            message.innerHTML = "";
            let typeMessageIterator = 0;
            type();
            function type() {
                if (typeMessageIterator < str.length){
                    console.log("Typing" + str.charAt(typeMessageIterator));
                    message.innerHTML += str.charAt(typeMessageIterator++);

                    setTimeout(type, typeMessageSpeed);
                }else{
                    typeMessageIterator = 0;
                    typing = false;
                }
            }
        }

        /*

        // Catch add item
        ipcRenderer.on('item:add', (e, item)=>{
            ul.className = 'collection';
            const li = document.createElement('li');
            li.className = 'collection-item';
            const itemText = document.createTextNode(item);
            li.appendChild(itemText);
            ul.appendChild(li);
        });

        // Catch clear items
        ipcRenderer.on('item:clear', ()=>{
            ul.innerHTML = '';
            ul.className = '';
        });

        // Remove Item on double click
        ul.addEventListener('dblclick', removeItem);

        function removeItem(e) {
            e.target.remove();
            if(ul.children.length == 0){
                ul.className = '';
            }
        }
        */

    </script>
</body>
</html>