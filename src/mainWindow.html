<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="dao.js"></script>
    <title>Terminal</title>
    <link rel="stylesheet" href="App.css">
</head>
<body>
    <div class="container">
        <div>
            <div class="root">
                ~custodianOS $
            </div>
            <div class="message"></div>
            <br style="clear: both"/>
            <br style="clear: both"/>
            <div class="text"></div>
        </div>
    </div>
    <script>

        const electron = require('electron');
        const {ipcRenderer} = electron;
        const message = document.querySelector(".message");
        const text = document.querySelector(".text");

        let typing = false;
        let continueMessage = false;
        let introMessage = false;
        let userID = 0;
        let question = "";
        let answer = "";
        let passcode = "";
        let typeMessageSpeed = 10; // The speed of the messages from the system being typed
        let stage = 0;




        text.innerHTML = ""; // Prevents garbage data from initialization

        typeMessage("Welcome to CustodianOS, please type your provided identification number.");

        window.onkeydown = key => this.handleKeyPress(key);

        handleKeyPress = (event) =>{
            if(typing){
                return;
            }

            if (event.key === 'Enter'){
                console.log("Enter pressed!");
                handleCommand();
            }else if (event.keyCode === 8){
                console.log("Backspace pressed!");
                text.innerHTML = text.innerHTML.substr(0, text.innerHTML.length-1);
            }else if(event.keyCode < 48 && event.keyCode !== 32){
                event.preventDefault();
            }
            else {
                text.innerHTML += event.key;
            }
        };

        // Catch test clear
        ipcRenderer.on('text:clear', ()=>{
            text.innerHTML = "";
        });

        function fetchQuestion() {
            console.log("Fetching question " + stage);
            query("SELECT * FROM Question WHERE Stage = ?", [stage]).then(res =>{
                console.log("inside question query response");
                question = res.Question;
                answer = res.Answer;
                typeMessage("Question " + stage + " of 6\n" + res.Question);
            });
            return;
        }

        async function handleCommand() {
            console.log("Handling command!");
            let command = text.innerHTML.replace(/\s/g, " ").toLowerCase();
            text.innerHTML = "";

            if (continueMessage){
                switch (command) {
                    case "y":
                        fetchQuestion();
                        continueMessage = false;
                        return;
                    case "n":
                        typeMessage("Your loss");
                        setTimeout(function(){ typeMessage("If you change your mind: press Y") }, 3000);
                        return;
                    default:
                        return;
                }
            }

            if (introMessage){
                switch (command) {
                    case "y":
                        introMessage = false;
                        fetchQuestion();
                        return;
                    case "n":
                        typeMessage("Your loss");
                        setTimeout(function(){ typeMessage("If you change your mind: press Y") }, 3000);
                        return;
                    default:
                        return;
                }
            }

            if (command === "-joke"){
                message.innerHTML = "";
                typeMessage("Don’t use “beef stew” as a computer password. It’s not stroganoff.");
                return;
            }else{
                switch (stage) {
                    case 0:
                        query("SELECT * FROM User where ID = ?", [command]).then(res =>{

                            if (res == undefined){
                                typeMessage("Identification number not recognized, please try again.")
                            }else{
                                console.log("name: " + res.Name);
                                stage = res.Stage;
                                userID = res.ID;
                                passcode = res.Passcode;


                                if (stage === 0){
                                    stage++;
                                    query("UPDATE User SET Stage = ? WHERE ID = ?", [stage, userID]);
                                    typeMessage("Welcome " + res.Name + ", I am the Custodian of your Christmas gift. Your gift is protected by a secret passcode. To get the passcode, you must first answer all of my conundrums. Are you ready? [Y/N]");
                                    introMessage = true;

                                }else {
                                    typeMessage("Welcome back " + res.Name + " would you like to continue on your quest? [Y/N]");
                                    continueMessage = true;
                                }
                            }
                        });
                        break;

                    case 6:
                        if(command.includes(answer.toLowerCase())){
                            if (userID == 619252){
                                typeMessage("Congratulations!\nYou have completed all of my conundrums!\n" +
                                    "The passcode to your present is: " + passcode + "\nPlease tell this passcode to your mother to receive your present!\nMerry Christmas!")
                            }else {
                                typeMessage("Congratulations!\nYou have completed all of my conundrums!\n" +
                                    "The passcode to your present is: " + passcode);
                            }
                        }else{
                            typeMessage("Wrong");
                            setTimeout(typeMessage, 2000, question);
                        }
                        break;

                    default:
                        if(command.includes(answer.toLowerCase())){
                            stage++;
                            query("UPDATE User SET Stage = ? WHERE ID = ?", [stage, userID]);
                            typeMessage("Correct!");
                            setTimeout(fetchQuestion, 3000);
                        }else{
                            typeMessage("Wrong");
                            setTimeout(typeMessage, 2000, question);
                        }
                        break;
                }
            }
        }

        function typeMessage(str){
            if (typing){
                return;
            }
            typing = true;
            message.innerHTML = "";
            let typeMessageIterator = 0;
            type();
            function type() {
                if (typeMessageIterator < str.length){
                    message.innerHTML += str.charAt(typeMessageIterator++);
                    setTimeout(type, typeMessageSpeed);
                }else{
                    typeMessageIterator = 0;
                    typing = false;
                }
            }
        }
    </script>
</body>
</html>